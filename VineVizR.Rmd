---
title: "Iris K-Means Clustering"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: embed
runtime: shiny
---

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard

for(i in list.files("R/", full.names = T)) source(i)

# Download Top40 on JSE
load_pkg(c(
  "dplyr", 
  "tidyr",
  "tibble",
  "ggplot2",
  "quantmod",
  "PerformanceAnalytics",
  "rugarch",
  "VineCopula",
  "visNetwork"
))


```

```{r, data_wrangling}
RVM <- readRDS("data/RVM.rds")

Market_info <- read.csv("data/Market_info.csv", stringsAsFactors = F)
Market_info <- 
  Market_info %>% mutate(Year1_Move = cut(X1.Year..Move,
                                       c("-Inf", 
                                          quantile(X1.Year..Move), 
                                          "Inf"),
                                       labels = c("Worst", "Negative", "Average", "Pos ret", "High ret", "Best")),
                       Year5_Move = cut(X5.year..Move,
                                       c("-Inf", 
                                          quantile(X5.year..Move), 
                                          "Inf"),
                                       labels = c("Worst", "Negative", "Average", "Pos ret", "High ret", "Best")),
                       MCapBillion = cut(Market.Cap/1e+09,
                                       c("-Inf", 
                                          quantile(Market.Cap)/1e+09, 
                                          "Inf")
                                       ))

```



Column {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput('group', 'Generate Grouping', c("Market Cap", "Industry", "Volatility", "1 Year Performance","5 Year Performance"))

numericInput('seed', 'Random formation seed', 3, 
              min = 1, max = 999)
```

Column
-----------------------------------------------------------------------
```{r}
require(visNetwork, quietly = TRUE)
# minimal example


if (input$group == "Market Cap")
{
    group <- Market_info$MCapBillion %>% as.character()
    group.size <-  
      Market_info %>% 
      group_by(MCapBillion) %>%
      summarise(n = n()) %>% 
      select(n) %>% unlist
      
    colours <- c("#39c9bb", 	"#398fc9", 	"#39c973","#c93947", "#bb39c9")
} else if (input$group == "Industry"){
    group <- Market_info$Hanjo.Industry %>% as.character()
    group.size <-  
      Market_info %>% 
      group_by(Hanjo.Industry) %>%
      summarise(n = n()) %>% 
      select(n) %>% unlist 
    colours <- c("#39c9bb", 	"#398fc9", 	"#39c973")
} else if (input$group == "1 Year Performance"){
    group <- Market_info$Year1_Move %>% as.character()
    group.size <-  
      Market_info %>% 
      group_by(Year1_Move) %>%
      summarise(n = n()) %>% 
      select(n) %>% unlist 
    colours <- c("#39c9bb", 	"#398fc9", 	"#39c973")
} else if (input$group == "5 Year Performance"){
    group <- Market_info$Year5_Move %>% as.character()
    group.size <-  
      Market_info %>% 
      group_by(Year5_Move) %>%
      summarise(n = n()) %>% 
      select(n) %>% unlist 
    colours <- c("#39c9bb", 	"#398fc9", 	"#39c973")
}

renderVisNetwork({
  VisVineR(
    RVM,
    group = group,
    group.size = group.size,
    seed = 20, 
    colours = colours
    )
  })

```

